#!/bin/bash
# Author: sfs <https://puppyrus.org>
# Author: crims0n <https://minios.dev>

. /usr/lib/minioslib || exit 1

[ ! "$1" ] && echo "Builds a common dpkg database from all bundles
    Usage:   $0 [bundles mount points location]
    Example: $0 /run/initramfs/memory/bundles" && exit 1

function get_installed_packages() {
    if [ -d "$1" ]; then
        ls -1 "$1"/var/lib/dpkg/info/*.md5sums | sed -n 's,^.*/var/lib/dpkg/info/\([^:]*\)\(:.\+\)\?\.md5sums$,\1,p'
    else
        unsquashfs -l "$1" | sed -n 's,^.*/var/lib/dpkg/info/\([^:]*\)\(:.\+\)\?\.md5sums$,\1,p'
    fi
}

if [ ! -d /var/log/minios ]; then
    mkdir -p /var/log/minios
fi

exec 19>/var/log/minios/minios-update-dpkg.trace
BASH_XTRACEFD=19
set -x

BUNDLES="$1"
read_config /etc/minios/minios.conf CORE_BUNDLE_PREFIX
CORE_BUNDLE_PREFIX=${CORE_BUNDLE_PREFIX:-"00-core"}
read_config /etc/minios/config BEXT
BEXT=${BEXT:-"sb"}
DPKG_STATUS_FILE=/var/lib/dpkg/status

[ -d $(dirname $DPKG_STATUS_FILE) ] || exit

if [ -d /run/initramfs/memory/changes ]; then
    CHANGES="/run/initramfs/memory/changes"
elif [ -d /memory/changes ]; then
    CHANGES="/memory/changes"
fi

if [ -d "$CHANGES/changes" -a -d "$CHANGES/workdir" -a "$(ls -1 "$CHANGES" | egrep -v '^changes$' | egrep -v '^workdir')" = "" ]; then
    CHANGES="$CHANGES/changes"
fi

allow_root_only

cat "$BUNDLES"/*."$BEXT"/var/lib/dpkg/statoverride | sort -u >/var/lib/dpkg/statoverride

TEMP_FILE=$(mktemp /run/dpkg_status_file.XXXXXX)
trap 'rm -f "$TEMP_FILE"*' EXIT

for CORE_BUNDLE_PATH in "$BUNDLES"/"$CORE_BUNDLE_PREFIX"*."$BEXT"; do
    cp "$CORE_BUNDLE_PATH$DPKG_STATUS_FILE" "$TEMP_FILE" || exit
done

for BUNDLE in $(ls -1d $BUNDLES/*.$BEXT | egrep -v "^$CORE_BUNDLE_PATH"); do
    [ -f "$BUNDLE$DPKG_STATUS_FILE" ] || continue

    cat "$BUNDLE$DPKG_STATUS_FILE" >>"$TEMP_FILE"
    get_installed_packages "$BUNDLE" >>"$TEMP_FILE-packages.list"
done

cp "$TEMP_FILE-packages.list" "/var/log/minios/packages-bundles.list"

cat "$CHANGES$DPKG_STATUS_FILE" >>"$TEMP_FILE"
get_installed_packages "$CHANGES" >>"$TEMP_FILE-packages.list"

cp "$TEMP_FILE-packages.list" "/var/log/minios/packages-changes.list"

get_installed_packages "$CORE_BUNDLE_PATH" | sort -u >>"$TEMP_FILE-core_bundle_packages.list"
sort -u "$TEMP_FILE-packages.list" >"$TEMP_FILE-packages_sorted.list"

cp "$TEMP_FILE-packages_sorted.list" "/var/log/minios/packages_sorted.list"

comm -1 -3 "$TEMP_FILE-core_bundle_packages.list" "$TEMP_FILE-packages_sorted.list" >"$TEMP_FILE-packages_unique.list"

cp "$TEMP_FILE-packages_unique.list" "/var/log/minios/packages_unique.list"

if [ -f "/var/log/minios/statusfile" ]; then
    rm "/var/log/minios/statusfile"
fi
for PACKAGE in $(sort -u "$TEMP_FILE-packages_unique.list" | sed 's/+/\\\+/g'); do
    awk '/^Package: '$PACKAGE'$/ {p=1} p==1 {print} /^$/ {if (p==1) exit}' "$TEMP_FILE" >>$DPKG_STATUS_FILE
    awk '/^Package: '$PACKAGE'$/ {p=1} p==1 {print} /^$/ {if (p==1) exit}' "$TEMP_FILE" >>"/var/log/minios/statusfile"
done
