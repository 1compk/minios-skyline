#!/bin/bash
# Author: sfs <https://puppyrus.org>
# Author: crims0n <https://minios.dev>

. /usr/lib/minioslib || exit 1

[ ! "$1" ] && echo "Builds a common dpkg database from all bundles
    Usage:   $0 [bundles mount points location]
    Example: $0 /run/initramfs/memory/bundles" && exit 1

# Logs
if [ ! -d /var/log/minios ]; then
    mkdir -p /var/log/minios
fi
exec 19>/var/log/minios/minios-update-dpkg.trace
BASH_XTRACEFD=19
PS4='${LINENO}: '
set -x

# Variables
BUNDLES="$1"
read_config /etc/minios/config BEXT
BEXT=${BEXT:-"sb"}
DPKG_STATUS_FILE=/var/lib/dpkg/status

[ -d $(dirname $DPKG_STATUS_FILE) ] || exit

allow_root_only

if [ -x "$(command -v apt)" ]; then
    chmod -x $(command -v apt)
fi
if [ -x "$(command -v apt-get)" ]; then
    chmod -x $(command -v apt-get)
fi
if [ -x "$(command -v dpkg)" ]; then
    chmod -x $(command -v dpkg)
fi

cat "$BUNDLES"/*."$BEXT"/var/lib/dpkg/statoverride | sort -u >/var/lib/dpkg/statoverride

TEMP_FILE=$(mktemp /run/dpkg_status_file.XXXXXX)
trap 'rm -f "$TEMP_FILE"*' EXIT

if [ -f "/var/log/minios/statusfile" ]; then
    rm "/var/log/minios/statusfile"
fi
if [ -f "$DPKG_STATUS_FILE" ]; then
    rm "$DPKG_STATUS_FILE"
fi
cat $(ls "$BUNDLES"/*/var/lib/dpkg/status) >"$TEMP_FILE"
for PACKAGE in $(awk -F"Package: " '/^Package: / {print $2}' "$TEMP_FILE" | sort -u | sed 's/+/\\\+/g'); do
    awk '/^Package: '$PACKAGE'$/ {p=1} p==1 {print} /^$/ {if (p==1) exit}' "$TEMP_FILE" >>$DPKG_STATUS_FILE
done
cp $DPKG_STATUS_FILE /var/log/minios/statusfile

if [ ! -x "$(command -v apt)" ]; then
    chmod +x $(command -v apt)
fi
if [ ! -x "$(command -v apt-get)" ]; then
    chmod +x $(command -v apt-get)
fi
if [ ! -x "$(command -v dpkg)" ]; then
    chmod +x $(command -v dpkg)
fi
