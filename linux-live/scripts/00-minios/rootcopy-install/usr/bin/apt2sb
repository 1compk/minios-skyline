#!/bin/bash

aufs_is_supported() {
   cat /proc/filesystems | grep aufs
}

. /usr/lib/minioslib || exit 1

[ ! "$1" ] && echo "Installs packages from repositories and packages them into a module.
    Usage:   $0 [package names]
    Example: $0 chromium chromium-sandbox" && exit 1

allow_root_only

read_config /etc/minios/config BEXT

TMP=/tmp/tmpfs$$
CHANGES=$TMP/changes
UNION=$TMP/union
if [ -d /run/initramfs/memory/bundles ]; then
   BUNDLES=/run/initramfs/memory/bundles
elif [ -d /memory/bundles ]; then
   BUNDLES=/memory/bundles
fi
INSTALL="$1"
[ -n "$INSTALL" ] || exit
# In case multiple packages were specified on the command line.
INSTALL_ALL="$@"

mkdir -p $TMP
mount -t tmpfs tmpfs $TMP
mkdir -p $CHANGES
mkdir -p $UNION

## Filter out all modules with numbers 04-09, so that any module can be used with the base system with modules 00-03.
LOWERS=$(\ls -1dr $BUNDLES/[0]* | grep -v "0[4-9]" | tr '\n' ':')
LOWERS=${LOWERS/%:/}
rm -rf $TMP/xino
mkdir $TMP/xino
mount -t overlay -o lowerdir=$LOWERS,upperdir=$CHANGES,workdir=$TMP/xino overlay $UNION

for d in boot dev proc sys tmp media mnt run; do
   mkdir -p $UNION/$d
done

chmod ugo+rwx $UNION/tmp

mount --bind /dev $UNION/dev
mount --bind /proc $UNION/proc
mount --bind /sys $UNION/sys

echo "apt-get update; apt-get install --yes $INSTALL_ALL" >$UNION/doit
chmod ugo+x $UNION/doit
cp /etc/resolv.conf $UNION/etc/
chroot $UNION /doit

umount $UNION/sys
umount $UNION/proc
umount $UNION/dev
rm $CHANGES/doit
rmdir $CHANGES/* 2>/dev/null
#cleanup.sh $CHANGES
savechanges /"$INSTALL".$BEXT $CHANGES

umount $UNION
umount $TMP
rmdir $TMP
