#!/bin/bash
# Author: sfs <https://puppyrus.org>
# Author: crims0n <https://minios.dev>

. /usr/lib/minioslib || exit 1

[ ! "$1" ] && echo "Builds a common dpkg database from all bundles
    Usage:   $0 [bundles mount points location]
    Example: $0 /run/initramfs/memory/bundles" && exit 1

if [ ! -d /var/log/minios ]; then
    mkdir -p /var/log/minios
fi
exec 19>/var/log/minios/dpkg-fix.log
BASH_XTRACEFD=19
set -x

BUNDLES=$1
read_config /etc/minios/minios.conf CORE_BUNDLE_PREFIX
if [ -z "$CORE_BUNDLE_PREFIX" ]; then
    CORE_BUNDLE_PREFIX="00-core"
fi
read_config /etc/minios/config BEXT
if [ -z "$BEXT" ]; then
    BEXT="sb"
fi
CORE_BUNDLE_PATH="$(ls -1d $BUNDLES/$CORE_BUNDLE_PREFIX*.$BEXT)"

allow_root_only

DPKG_STATUS_FILE=/var/lib/dpkg/status
[ -d $(dirname $DPKG_STATUS_FILE) ] || exit
cat $BUNDLES/*.$BEXT/var/lib/dpkg/statoverride |
    sort -u >/var/lib/dpkg/statoverride
TEMP_FILE=/run/dpkg-fix
rm $TEMP_FILE* 2>/dev/null
cp $CORE_BUNDLE_PATH$DPKG_STATUS_FILE $TEMP_FILE || exit
cp $TEMP_FILE $DPKG_STATUS_FILE

for BUNDLE in $(ls -1d $BUNDLES/*.$BEXT | egrep -v "^$CORE_BUNDLE_PATH"); do
    [ -f "$BUNDLE$DPKG_STATUS_FILE" ] || continue
    cat $BUNDLE$DPKG_STATUS_FILE >>$TEMP_FILE
    pfsdeb $BUNDLE >>$TEMP_FILE-p
done

pfsdeb "$CORE_BUNDLE_PATH" | sort -u >>$TEMP_FILE-p1u
sort -u $TEMP_FILE-p >$TEMP_FILE-pu
comm -1 -3 $TEMP_FILE-p1u $TEMP_FILE-pu >$TEMP_FILE-p

for PACKAGE in $(sort -u "$TEMP_FILE-p" | sed 's/+/\\\+/g'); do
    awk '/^Package: '$PACKAGE'$/ {p=1} p==1 {print} /^$/ {if (p==1) exit}' "$TEMP_FILE" >>$DPKG_STATUS_FILE
done
PACKAGE=""

rm $TEMP_FILE*
exit

TEMP_DPKG_STATUS_FILE=/run/dpkg-status
mv $TEMP_FILE $TEMP_DPKG_STATUS_FILE
cat "$TEMP_DPKG_STATUS_FILE" | sed -n 's/^Package: //p' | sort | uniq -c | sort -n | egrep -v '^[[:blank:]]*1 ' | while read COUNT PACKAGE; do
    awk 'BEGIN {n=0;f=1;c='"$COUNT"'} /^Package: '"$PACKAGE"'$/ {n+=1;if (n<c) {f=0;next}} /^[[:blank:]]*$/ && f==0 {f=1;next} f' $TEMP_DPKG_STATUS_FILE >$TEMP_FILE
    mv $TEMP_FILE $TEMP_DPKG_STATUS_FILE
done
mv "$TEMP_DPKG_STATUS_FILE" "$DPKG_STATUS_FILE"
