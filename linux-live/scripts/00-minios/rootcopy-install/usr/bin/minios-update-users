#!/bin/bash
# Author: crims0n <https://minios.dev>

. /usr/lib/minioslib || exit 1

[ ! "$1" ] && echo "Builds a common users files (passwd, shadow, group, gshadow) from all bundles
    Usage:   $0 [bundles mount points location]
    Example: $0 /run/initramfs/memory/bundles" && exit 1

if [ ! -d /var/log/minios ]; then
    mkdir -p /var/log/minios
fi

exec 19>/var/log/minios/minios-update-users.trace
BASH_XTRACEFD=19
set -x
if [ ! -d /var/log/minios/users ]; then
    mkdir -p /var/log/minios/users
fi

BUNDLES=$1
read_config /etc/minios/minios.conf CORE_BUNDLE_PREFIX
CORE_BUNDLE_PREFIX=${CORE_BUNDLE_PREFIX:-"00-core"}
read_config /etc/minios/config BEXT
BEXT=${BEXT:-"sb"}
CORE_BUNDLE_PATH="$(ls -1d $BUNDLES/$CORE_BUNDLE_PREFIX*.$BEXT)"
if [ -d /run/initramfs/memory/changes ]; then
    CHANGES="/run/initramfs/memory/changes"
    INITRD_TYPE="livekit"
elif [ -d /memory/changes ]; then
    CHANGES="/memory/changes"
    INITRD_TYPE="uird"
fi

if [ -d "$CHANGES/changes" -a -d "$CHANGES/workdir" -a "$(ls -1 "$CHANGES" | egrep -v '^changes$' | egrep -v '^workdir')" = "" ]; then
    CHANGES="$CHANGES/changes"
fi

allow_root_only

TMP=$(mktemp -d)
trap 'rm -rf $TMP' EXIT

for FILE in {passwd,shadow,group,gshadow}; do
    if [ -f "$CORE_BUNDLE_PATH/etc/$FILE" ]; then
        cp "$CORE_BUNDLE_PATH/etc/$FILE" "$TMP/$FILE.bundles" || exit
        cp "$TMP/$FILE.bundles" "/var/log/minios/users/$FILE.core"
    fi

    if [ -f "$CHANGES/etc/$FILE" ]; then
        cp "$CHANGES/etc/$FILE" "$TMP/$FILE.changes" || exit
        cp "$CHANGES/etc/$FILE" "/var/log/minios/users/$FILE.changes"
    fi

done

for BUNDLE in $(ls -1d $BUNDLES/*.$BEXT | egrep -v "^$CORE_BUNDLE_PATH"); do
    for FILE in {passwd,shadow,group,gshadow}; do
        if [ -f "$BUNDLE/etc/$FILE" ]; then
            echo "$FILE exists in $(basename $BUNDLE)."
            grep -Fvf "$TMP/$FILE.bundles" "$BUNDLE/etc/$FILE" >>"$TMP/$FILE.bundles"
            cp "$BUNDLE/etc/$FILE" "/var/log/minios/users/$FILE.$(basename $BUNDLE)"
            cp "$TMP/$FILE.bundles" "/var/log/minios/users/$FILE.bundles"
        fi
    done
done

for FILE in {passwd,shadow,group,gshadow}; do
    if [ -f "$TMP/$FILE.changes" ]; then
        
        grep -Fvf "$TMP/$FILE.changes" "$TMP/$FILE.bundles" >>"$TMP/$FILE.changes"
        cp "$TMP/$FILE.changes" "/var/log/minios/users/$FILE.bundles"

        awk '!x[$0]++' "$TMP/$FILE.changes" >"/etc/$FILE"
        cp "/etc/$FILE" "/var/log/minios/users/$FILE"

    elif [ -f "$TMP/$FILE.bundles" ]; then
        awk '!x[$0]++' "$TMP/$FILE.bundles" >"/etc/$FILE"
    fi
done

exit
