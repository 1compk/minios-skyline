#!/bin/bash
# Author: crims0n <https://minios.dev>

. /usr/lib/minioslib || exit 1

[ ! "$1" ] && echo "Builds a common users files (passwd, shadow, group, gshadow) from all bundles
    Usage:   $0 [bundles mount points location]
    Example: $0 /run/initramfs/memory/bundles" && exit 1

if [ ! -d /var/log/minios ]; then
    mkdir -p /var/log/minios
fi
exec 19>/var/log/minios/minios-update-users.log
BASH_XTRACEFD=19
set -x

BUNDLES=$1
read_config /etc/minios/minios.conf CORE_BUNDLE_PREFIX
if [ -z "$CORE_BUNDLE_PREFIX" ]; then
    CORE_BUNDLE_PREFIX="00-core"
fi
read_config /etc/minios/config BEXT
if [ -z "$BEXT" ]; then
    BEXT="sb"
fi
CORE_BUNDLE_PATH="$(ls -1d $BUNDLES/$CORE_BUNDLE_PREFIX*.$BEXT)"
if [ -d /run/initramfs/memory/changes ]; then
    CHANGES="/run/initramfs/memory/changes"
    INITRD_TYPE="livekit"
elif [ -d /memory/changes ]; then
    CHANGES="/memory/changes"
    INITRD_TYPE="uird"
fi

for FILE in passwd shadow group gshadow; do
    cp $CORE_BUNDLE_PATH/etc/$FILE /tmp/$FILE.bundlesfile || exit
    if [ -f "$CHANGES/var/.minios-setup-completed" ]; then
        cp $CHANGES/etc/$FILE /tmp/$FILE.changesfile || exit
    fi
done
for BUNDLE in $(ls -1d $BUNDLES/*.$BEXT | egrep -v "^$CORE_BUNDLE_PATH"); do
    for FILE in passwd shadow group gshadow; do
        if [ -f "$BUNDLE/etc/$FILE" ]; then
            grep -Fvf /tmp/$FILE.bundlesfile $BUNDLE/etc/$FILE >>/tmp/$FILE.bundlesfile
            #awk '!x[$0]++' /tmp/$FILE.bundlesfile >/etc/$FILE
        fi
    done
done
for FILE in passwd shadow group gshadow; do
    grep -Fvf /tmp/$FILE.changesfile /tmp/$FILE.bundlesfile >>/tmp/$FILE.changesfile
    awk '!x[$0]++' /tmp/$FILE.changesfile >/etc/$FILE
done

rm /tmp/*.bundlesfile
rm /tmp/*.changesfile
