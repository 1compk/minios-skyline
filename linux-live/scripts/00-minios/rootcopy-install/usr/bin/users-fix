#!/bin/bash
# Author: crims0n <https://minios.dev>

. /usr/lib/minioslib || exit 1

[ ! "$1" ] && echo "Builds a common users files (passwd, shadow, group) from all bundles
    Usage:   $0 [bundles mount points location]
    Example: $0 /run/initramfs/memory/bundles" && exit 1

BUNDLES=$1
read_config /etc/minios/minios.conf CORE_BUNDLE_PREFIX
read_config /etc/minios/config BEXT

for FILE in passwd shadow group; do
    cp $BUNDLES/$CORE_BUNDLE_PREFIX*.$BEXT/etc/$FILE /tmp/$FILE.tempfile || exit
done
for BUNDLE in $(ls -1d $BUNDLES/*.$BEXT | egrep -v "^$BUNDLES/$CORE_BUNDLE_PREFIX"); do
    for FILE in passwd shadow group; do
        if [ -f "$BUNDLE/etc/$FILE" ]; then
            grep -Fvf /tmp/$FILE.tempfile $BUNDLE/etc/$FILE >>/tmp/$FILE.tempfile
            awk '!x[$0]++' /tmp/$FILE.tempfile >/etc/$FILE
        fi
    done
done

rm /tmp/*.tempfile
