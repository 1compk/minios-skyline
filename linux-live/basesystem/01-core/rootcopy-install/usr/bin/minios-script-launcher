#!/bin/bash

# Author: crims0n. <https://minios.ru>
# Author: Patrick Verner and Jason Vasquez

. /run/initramfs/lib/config || exit 1
. /run/initramfs/lib/buildconfig || exit 1
. /run/initramfs/lib/minioslib || exit 1

CMDLINE=$(cat /proc/cmdline)
read_cmdline $CMDLINE

if [ $FLAGS = "toram" ]; then
    MEDIA="/run/initramfs/memory/toram"
else
    MEDIA="/run/initramfs/memory/data/$LIVEKITNAME"
fi

FX=
script_header() {
    if [ -z "$FX" ]; then
        echo -e "${CYAN}Executing user scripts... ${YELLOW}\n"
        FX=FX
    fi
}

_script_list() {
    for F in $(ls $1/scripts/* 2>/dev/null); do
        script_header
        echo ">>> $F"
        if [ -x $F ]; then
            $F
        else
            read FF <$F &>/dev/null
            FFF=${FF###!}
            echo $FFF
            [ ".$FFF" != ".$FF" ] && FFF=${FFF%% } || FFF=
            [ -n "$FFF" ] && $FFF $F || /bin/sh $F
        fi
        [ -n "$2" ] && rm -f $F
    done
}

script_list() { _script_list $1 $2; }

if [ "$scripts" != "no" ]; then
    script_list $MEDIA
    [ -n "$FX" ] && echo -e "${ENDCOLOR}"
fi
